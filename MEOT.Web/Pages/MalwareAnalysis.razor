@page "/MalwareAnalysis/{id}"

@using System.Linq

@using MEOT.lib.DAL.Base
@using MEOT.lib.Objects

@inject IDAL db

<h1>@malware.Name Breakdown</h1>

<h2>Overview</h2>

<p>
    <label>
        SHA1: @malware.SHA1
    </label>
</p>

<p>
    <label>
        @malwareCheckpoint.Detections out of @malwareCheckpoint.Vendors vendors
    </label>
</p>

<h2>Vendor Detected Breakdown</h2>

@if (vendorBreakdown == null)
{
    <p><em>Loading...</em></p>
}
else if (!vendorBreakdown.Any())
{
    <p>No Vendors currently catch this malware</p>
} else  {
    <table class="table">
        <thead>
        <tr>
            <th>Vendor Name</th>
            <th>Hours to Classification</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var item in vendorBreakdown.Where(a => a.Detected))
        {
            <tr>
                <td>@item.VendorName</td>
                <td>@item.HoursToDetection></td>
            </tr>
        }
        </tbody>
    </table>
}

<h2>Vendor Undetected Breakdown (@malware.DayZero.Subtract(DateTimeOffset.Now).TotalHours Hours since inception)</h2>

@if (vendorBreakdown == null)
{
    <p><em>Loading...</em></p>
}
else if (vendorBreakdown.All(a => a.Detected))
{
    <p>No Vendors currently classify this as benign</p>
} else  {
    <table class="table">
        <thead>
        <tr>
            <th>Vendor Name</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var item in vendorBreakdown.Where(a => !a.Detected))
        {
            <tr>
                <td>@item.VendorName</td>
            </tr>
        }
        </tbody>
    </table>
}

@code {
    [Parameter]
    public string id { get; set; }

    private List<MalwareVendorCheckpoint> vendorBreakdown;

    private MalwareCheckpoint malwareCheckpoint;

    private Malware malware;

    protected override async Task OnInitializedAsync()
    {
        var malwareId = Convert.ToInt32(id);

        malware = db.SelectOne<Malware>(malwareId);
        malwareCheckpoint = db.SelectAll<MalwareCheckpoint>().FirstOrDefault(a => a.MalwareId == malwareId);

        vendorBreakdown = db.SelectAll<MalwareVendorCheckpoint>().Where(a => a.MalwareId == malwareId).OrderBy(a => a.VendorName).ToList();
    }
}