@page "/MalwareAnalysis/{query}"

@using System.Linq

@using MEOT.lib.Managers
@using MEOT.lib.Objects

@inject MalwareManager malwareManager
@inject NavigationManager navManager

@if (malware == null)
{
    <p>Loading...</p>
}
else
{
    <h1>@malware.Name</h1>

    <h2>Overview</h2>

    <div class="card bg-dark text-white">
        <div class="card-body">
            <p>
                <label>
                    <strong>MD5</strong><br/> 
                    <span class="text-uppercase">@malware.MD5</span>
                </label>
            </p>

            <p>
                <label>
                    <strong>SHA1</strong><br/>
                    <span class="text-uppercase">@malware.SHA1</span>
                </label>
            </p>
            
            <p>
                <label>
                    <strong>SHA256</strong><br/>
                    <span class="text-uppercase">@malware.SHA256</span>
                </label>
            </p>

            <p>
                <label>
                    <strong class="text-uppercase">threat feed sources</strong><br/>
                    <a href="https://www.virustotal.com/gui/file/@malware.SHA1/detection" target="_blank">VirusTotal</a>
                </label>
            </p>

            @if (malwareCheckpoint == null)
            {
                <p>
                    Analysis has not been run yet
                </p>
            }
            else
            {
                <p>
                    <label>
                        <strong class="text-uppercase">Detections | Vendors</strong><br/>
                        @malwareCheckpoint?.Detections | @malwareCheckpoint?.Vendors
                    </label>
                </p>
            }
        </div>
    </div>

    <h2>Vendor Detected Breakdown</h2>
}

@if (vendorBreakdown == null || malware == null)
{
    <p><em>Loading...</em></p>
}
else if (!vendorBreakdown.Any() && malware != null)
{
    <p>No Vendors currently catch this malware</p>
} else  {
    <table class="table table-striped table-hover table-dark">
        <thead>
        <tr>
            <th>Vendor Name | Version</th>
            <th>Classification</th>
            <th>Date of Detection</th>
            <th>Hours to Classification</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var item in vendorBreakdown.Where(a => a.Detected))
        {
            <tr>
                <td><a href="/Vendor/@item.VendorName">@item.VendorName</a> | @item.VendorVersion</td>
                <td>@item.Classification</td>
                <td>
                    @if (item.DetectionDate.HasValue)
                    {
                        @item.DetectionDate.Value.ToShortDateString()
                    }
                </td>
                <td>@item.HoursToDetection</td>
            </tr>
        }
        </tbody>
    </table>

    <h2>Vendor Undetected Breakdown (@Math.Round(DateTimeOffset.Now.Subtract(malware.DayZero).TotalHours, 0) Hours since inception)</h2>
}


@if (vendorBreakdown == null)
{
    <p><em>Loading...</em></p>
}
else if (vendorBreakdown.All(a => a.Detected))
{
    <p>No Vendors currently classify this as benign</p>
} else  {
    <table class="table table-striped table-hover table-dark">
        <thead>
        <tr>
            <th>Vendor Name</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var item in vendorBreakdown.Where(a => !a.Detected))
        {
            <tr>
                <td><a href="/Vendor/@item.VendorName">@item.VendorName</a></td>
            </tr>
        }
        </tbody>
    </table>
}

@code {
    [Parameter]
    public string query { get; set; }

    private List<MalwareVendorCheckpoint> vendorBreakdown;

    private MalwareCheckpoint malwareCheckpoint;

    private Malware malware;

    protected override void OnInitialized()
    {
        malware = malwareManager.GetMalwareQuery(query);

        if (malware != null)
        {
            malwareCheckpoint = malwareManager.GetCheckpoint(malware.Id);

            vendorBreakdown = malwareManager.GetVendorCheckpoints(malware.Id);

            return;
        }

        navManager.NavigateTo("/404");
    }
}