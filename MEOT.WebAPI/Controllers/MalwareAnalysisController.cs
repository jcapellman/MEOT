using System;

using MEOT.lib.Containers;
using MEOT.lib.Managers;
using MEOT.lib.Objects;

using MEOT.WebAPI.Controllers.Base;

using Microsoft.AspNetCore.Mvc;

namespace MEOT.WebAPI.Controllers
{
    public class MalwareAnalysisController : BaseController
    {
        private MalwareManager _manager;

        public MalwareAnalysisController(MalwareManager manager)
        {
            _manager = manager;
        }

        [HttpPost]
        public void Add(string sha1Hash)
        {
            _manager.CreateOrUpdate(new Malware
            {
                Enabled = true,
                Created = DateTimeOffset.Now, 
                SHA1 = sha1Hash,
                Modified = DateTimeOffset.Now,
                DayZero = DateTimeOffset.Now,
                Format = null
            }, true);
        }

        // GET: api/MalwareAnalysis/query
        [HttpGet("{query}")]
        public MalwareAnalysisContainer Get(string query)
        {
            var queryResult = _manager.GetMalwareQuery(query);

            if (queryResult == null)
            {
                return null;
            }

            return new MalwareAnalysisContainer
            {
                malware = queryResult,
                malwareCheckpoint = _manager.GetCheckpoint(queryResult.Id),
                vendorBreakdown = _manager.GetVendorCheckpoints(queryResult.Id)
            };
        }
    }
}